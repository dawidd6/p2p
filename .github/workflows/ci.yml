name: CI

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  ci-proto:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install protobuf
        run: |
          brew update-reset
          brew install protobuf protoc-gen-go protoc-gen-go-grpc
      - name: Generate proto
        run: make proto
      - name: Check changes
        run: git diff --exit-code
  ci-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build image
        run: make image
      - name: Test integration
        env:
          IMG: p2p
        run: |
          # Create network
          docker network create p2p-network

          # Create torrent
          docker run --volume=$PWD:$PWD --workdir=$PWD --tty $IMG \
            p2p create --piece-size=4096 --tracker-host=tracker --tracker-port=8889 go.sum

          # Start tracker
          docker run --network=p2p-network --name=tracker --detach $IMG \
            p2ptrackerd

          # Start daemons
          docker run --network=p2p-network --name=daemon-seed --volume=$PWD:$PWD --workdir=$PWD --detach $IMG \
            p2pd --host=0.0.0.0 --port=8881 --seed-port=44441
          docker run --network=p2p-network --name=daemon-leech --workdir=$PWD --detach $IMG \
            p2pd --host=0.0.0.0 --port=8882 --seed-port=44442

          # Wait some time
          sleep 5s

          # Add torrents
          docker run --network=p2p-network --volume=$PWD:$PWD --workdir=$PWD --tty $IMG \
            p2p add --host=daemon-seed --port=8881 go.sum.torrent.json
          docker run --network=p2p-network --volume=$PWD:$PWD --workdir=$PWD --tty $IMG \
            p2p add --host=daemon-leech --port=8882 go.sum.torrent.json

          # Wait some time
          sleep 10s

          # Get statuses
          docker run --network=p2p-network --tty $IMG \
            p2p status --host=daemon-seed --port=8881
          docker run --network=p2p-network --tty $IMG \
            p2p status --host=daemon-leech --port=8882

          # Print logs
          echo "[command]docker logs tracker"
          docker logs tracker
          echo "[command]docker logs daemon-seed"
          docker logs daemon-seed
          echo "[command]docker logs daemon-leech"
          docker logs daemon-leech
