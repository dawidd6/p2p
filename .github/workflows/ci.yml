name: CI

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  ci-proto:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install protobuf
        run: |
          brew update-reset
          brew install protobuf protoc-gen-go protoc-gen-go-grpc
      - name: Generate proto
        run: make proto
      - name: Check changes
        run: git diff --exit-code
  ci-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build image
        run: make image
      - name: Test integration
        env:
          IMG: p2p
        run: |
          # Create network
          docker network create p2p-network

          # Create torrent
          docker run -v $PWD:$PWD -w $PWD -t $IMG \
            p2p create -s 4096 -t tracker:8889 go.sum

          # Start tracker
          docker run --network p2p-network --name tracker -d $IMG \
            p2ptrackerd -l 0.0.0.0 -p 8889

          # Start daemons
          docker run --network p2p-network --name daemon-seed -v $PWD:$PWD -w $PWD -d $IMG \
            p2pd -l 0.0.0.0 -p 8881 -P 44441
          docker run --network p2p-network --name daemon-leech -w $PWD -d $IMG \
            p2pd -l 0.0.0.0 -p 8882 -P 44442

          # Wait some time
          sleep 5s

          # Add torrents
          docker run --network p2p-network -v $PWD:$PWD -w $PWD -t $IMG \
            p2p add -l daemon-seed -p 8881 go.sum.torrent.json
          docker run --network p2p-network -v $PWD:$PWD -w $PWD -t $IMG \
            p2p add -l daemon-leech -p 8882 go.sum.torrent.json

          # Wait some time
          sleep 10s

          # Get statuses
          echo "[command]p2p status -l daemon-seed"
          docker run --network p2p-network -v $PWD:$PWD -w $PWD -t $IMG \
            p2p status -l daemon-seed -p 8881
          echo "[command]p2p status -l daemon-leech"
          docker run --network p2p-network -v $PWD:$PWD -w $PWD -t $IMG \
            p2p status -l daemon-leech -p 8882

          # Print logs
          echo "[command]docker logs tracker"
          docker logs tracker
          echo "[command]docker logs daemon-seed"
          docker logs daemon-seed
          echo "[command]docker logs daemon-leech"
          docker logs daemon-leech
